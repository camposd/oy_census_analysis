geom_errorbar(aes(ymin = percent_low, ymax = percent_upp),
position = position_dodge(width = 1)) +
labs(y = "Percent",
fill = "oy_flag")
school_attendance_region %>% names()
school_attendance_region %>%
filter(oy_flag != "everyone_else") %>%
ggplot(aes(x = PUMA_region, y = percent, fill = school_label, group = oy_flag)) +
geom_col(position = 'dodge') +
facet_wrap(~ )
school_attendance_region %>%
filter(oy_flag != "everyone_else") %>%
ggplot(aes(x = PUMA_region, y = percent, fill = school_label, group = oy_flag)) +
geom_col(position = 'dodge') +
facet_wrap(~ oy_flag) +
geom_errorbar(aes(ymin = percent_low, ymax = percent_upp),
position = position_dodge(width = 1)) +
labs(y = "Percent",
fill = "oy_flag")
school_attendance_region %>%
filter(oy_flag != "everyone_else") %>%
ggplot(aes(x = PUMA_region, y = percent, fill = school_label, group = oy_flag)) +
geom_col(position = 'dodge') +
facet_wrap(~ oy_flag) +
geom_errorbar(aes(ymin = percent_low, ymax = percent_upp),
position = position_dodge(width = 1)) +
labs(y = "Percent",
fill = "oy_flag")
school_attendance_region %>%
filter(!(oy_flag %in% c("everyone_else", "opp_youth"))) %>%
ggplot(aes(x = PUMA_region, y = percent, fill = school_label, group = oy_flag)) +
geom_col(position = 'dodge') +
facet_wrap(~ oy_flag) +
geom_errorbar(aes(ymin = percent_low, ymax = percent_upp),
position = position_dodge(width = 1)) +
labs(y = "Percent",
fill = "oy_flag")
school_attendance_region %>%
filter(!(oy_flag %in% c("everyone_else", "opp_youth"))) %>%
ggplot(aes(x = PUMA_region, y = percent, fill = school_label, group = oy_flag)) +
geom_col(position = 'dodge') +
# facet_wrap(~ oy_flag) +
geom_errorbar(aes(ymin = percent_low, ymax = percent_upp),
position = position_dodge(width = 1)) +
labs(y = "Percent",
fill = "oy_flag")
school_attendance_region %>%
filter(!(oy_flag %in% c("everyone_else", "opp_youth"))) %>%
ggplot(aes(x = PUMA_region, y = percent, fill = school_label, group = oy_flag)) +
geom_col(position = 'dodge') +
# facet_wrap(~ oy_flag) +
geom_errorbar(aes(ymin = percent_low, ymax = percent_upp),
position = position_dodge(width = 1)) +
labs(y = "Percent",
fill = "oy_flag")
school_attendance_region %>%
filter(!(oy_flag %in% c("everyone_else", "opp_youth"))) %>%
ggplot(aes(x = PUMA_region, y = percent, fill = school_label, group = oy_flag)) +
geom_col(position = 'dodge')
school_attendance_region %>%
filter(!(oy_flag %in% c("everyone_else", "opp_youth"))) %>%
ggplot(aes(x = PUMA_region, y = percent, fill = school_label, group = oy_flag)) +
geom_col(position = 'dodge')
school_attendance_region %>%
filter(!(oy_flag %in% c("everyone_else", "opp_youth"))) %>%
ggplot(aes(x = PUMA_region, y = percent, fill = school_label)) +
geom_col(position = 'dodge')
school_attendance_region %>%
filter(!(oy_flag %in% c("everyone_else", "opp_youth"))) %>%
ggplot(aes(x = PUMA_region, y = percent, fill = school_label, group = school_label)) +
geom_col(position = 'dodge')
school_attendance_region %>%
filter(!(oy_flag %in% c("everyone_else", "opp_youth"))) %>%
ggplot(aes(x = PUMA_region, y = percent, fill = school_label, group = school_label)) +
geom_col(position = 'dodge') +
# facet_wrap(~ oy_flag) +
geom_errorbar(aes(ymin = percent_low, ymax = percent_upp),
position = position_dodge(width = 1)) +
labs(y = "Percent",
fill = "oy_flag")
school_attendance_region
school_attendance_region %>% names()
school_attendance_region_label =
school_attendance_region %>%
group_by(PUMA_region) %>%
summarize(
n = sum(total)
)
school_attendance_region_label =
school_attendance_region %>%
group_by(PUMA_region) %>%
summarize(
n = sum(total)
) %>%
mutate(label = paste(PUMA_region, "\n", "N = ", n)) %>%
select(PUMA_region, label) %>%
spread(PUMA_region, label) %>%
unlist()
school_attendance_region
school_attendance_region_label
mutate(label = paste(PUMA_region, "\n", "N = ", format(n, big.mark = ',')) %>%
school_attendance_label
ls()
school_attendance_region_label
school_attendance_region_label =
school_attendance_region %>%
group_by(PUMA_region) %>%
summarize(
n = sum(total)
) %>%
mutate(label = paste(PUMA_region, "\n", "N = ", format(n, big.mark = ','))) %>%
select(PUMA_region, label) %>%
spread(PUMA_region, label) %>%
unlist()
school_attendance_region_label
school_attendance_region_label =
school_attendance_region %>%
group_by(PUMA_region) %>%
summarize(
n = sum(total)
) %>%
mutate(label = paste0(PUMA_region, "\n", "N =", format(n, big.mark = ','))) %>%
select(PUMA_region, label) %>%
spread(PUMA_region, label) %>%
unlist()
school_attendance_region_label
school_attendance_region %>%
filter(!(oy_flag %in% c("everyone_else", "opp_youth"))) %>%
ggplot(aes(x = PUMA_region, y = percent, fill = school_label, group = school_label)) +
geom_col(position = 'dodge') +
# facet_wrap(~ oy_flag) +
geom_errorbar(aes(ymin = percent_low, ymax = percent_upp),
position = position_dodge(width = 1)) +
labs(y = "Percent",
fill = "oy_flag") +
scale_x_discrete(labels = school_attendance_region_label) +
scale_y_continuous(labels = scales::percent)
school_attendance_region %>%
filter(!(oy_flag %in% c("everyone_else", "opp_youth"))) %>%
ggplot(aes(x = PUMA_region, y = percent, fill = school_label, group = school_label)) +
geom_col(position = 'dodge') +
# facet_wrap(~ oy_flag) +
geom_errorbar(aes(ymin = percent_low, ymax = percent_upp),
position = position_dodge(width = .9)) +
labs(y = "Percent",
fill = "oy_flag") +
scale_x_discrete(labels = school_attendance_region_label) +
scale_y_continuous(labels = scales::percent)
school_attendance_region %>%
filter(!(oy_flag %in% c("everyone_else", "opp_youth"))) %>%
ggplot(aes(x = PUMA_region, y = percent, fill = school_label, group = school_label)) +
geom_col(position = 'dodge') +
# facet_wrap(~ oy_flag) +
geom_errorbar(aes(ymin = percent_low, ymax = percent_upp),
position = position_dodge(width = .9),
width = .2)+
labs(y = "Percent",
fill = "oy_flag") +
scale_x_discrete(labels = school_attendance_region_label) +
scale_y_continuous(labels = scales::percent)
school_attendance_region %>%
filter(!(oy_flag %in% c("everyone_else", "opp_youth"))) %>%
ggplot(aes(x = PUMA_region, y = percent, fill = school_label, group = school_label)) +
geom_col(position = 'dodge') +
# facet_wrap(~ oy_flag) +
geom_errorbar(aes(ymin = percent_low, ymax = percent_upp),
position = position_dodge(width = .9),
width = .2)+
labs(y = "Percent",
fill = "School Attendance",
x = "Chicago Region") +
scale_x_discrete(labels = school_attendance_region_label) +
scale_y_continuous(labels = scales::percent)  +
theme_classic()
school_youth_attendance <-
pums_survey %>%
filter(oy_flag != "opp_youth") %>%
group_by(PUMA, oy_flag, school_label) %>%
summarize(
total = survey_total(vartype = c("se", "ci")),
percent = survey_mean(vartype = c("se", "ci"))
)
school_youth_attendance_labels <-
school_youth_attendance %>%
filter(oy_flag != "everyone_else") %>%
group_by(PUMA) %>%
summarize(
n = sum(total)
) %>%
mutate(label = paste(PUMA, "\n","N =", format(n, big.mark = ','))) %>%
select(PUMA, label) %>%
spread(PUMA, label) %>%
unlist()
school_youth_attendance %>%
filter(oy_flag != "everyone_else") %>%
ggplot(aes(x = PUMA, y = percent, fill = school_label, group = school_label)) +
geom_col(position = 'dodge') +
geom_errorbar(aes(ymin = percent_low, ymax = percent_upp),
width = .2,
position = position_dodge(width = 1)) +
theme_classic() +
scale_y_continuous(labels = scales::percent) +
scale_x_discrete(labels = school_youth_attendance_labels) +
labs(fill = "School Attendance Status",
y = "Percent")
school_attendance_region %>%
filter(!(oy_flag %in% c("everyone_else", "opp_youth"))) %>%
ggplot(aes(x = PUMA_region, y = percent, fill = school_label, group = school_label)) +
geom_col(position = 'dodge') +
# facet_wrap(~ oy_flag) +
geom_errorbar(aes(ymin = percent_low, ymax = percent_upp),
position = position_dodge(width = .9),
width = .2)+
labs(y = "Percent",
fill = "School Attendance",
x = "Chicago Region") +
scale_x_discrete(labels = school_attendance_region_label) +
scale_y_continuous(labels = scales::percent)  +
theme_classic()
ls()
school_youth_attendance
school_youth_attendance_labels <-
school_youth_attendance %>%
filter(oy_flag == "connected_youth") %>%
group_by(PUMA) %>%
summarize(
n = sum(total)
) %>%
mutate(label = paste(PUMA, "\n","N =", format(n, big.mark = ','))) %>%
select(PUMA, label) %>%
spread(PUMA, label) %>%
unlist()
school_youth_attendance_labels
school_youth_attendance %>%
filter(oy_flag != "everyone_else") %>%
ggplot(aes(x = PUMA, y = percent, fill = school_label, group = school_label)) +
geom_col(position = 'dodge') +
geom_errorbar(aes(ymin = percent_low, ymax = percent_upp),
width = .2,
position = position_dodge(width = 1)) +
theme_classic() +
scale_y_continuous(labels = scales::percent) +
scale_x_discrete(labels = school_youth_attendance_labels) +
labs(fill = "School Attendance Status",
y = "Percent")
school_attendance_region_label =
school_attendance_region %>%
filter(oy_flag == "connected_youth") %>%
group_by(PUMA_region) %>%
summarize(
n = sum(total)
) %>%
mutate(label = paste0(PUMA_region, "\n", "N =", format(n, big.mark = ','))) %>%
select(PUMA_region, label) %>%
spread(PUMA_region, label) %>%
unlist()
school_attendance_region %>%
filter(!(oy_flag %in% c("everyone_else", "opp_youth"))) %>%
ggplot(aes(x = PUMA_region, y = percent, fill = school_label, group = school_label)) +
geom_col(position = 'dodge') +
# facet_wrap(~ oy_flag) +
geom_errorbar(aes(ymin = percent_low, ymax = percent_upp),
position = position_dodge(width = .9),
width = .2)+
labs(y = "Percent",
fill = "School Attendance",
x = "Chicago Region") +
scale_x_discrete(labels = school_attendance_region_label) +
scale_y_continuous(labels = scales::percent)  +
theme_classic()
school_attendance_region_label
school_attendance_region
school_attendance_region <-
pums_survey %>%
group_by(PUMA_region, PUMA,oy_flag, school_label) %>%
summarize(
total = survey_total(vartype = c("se", "ci")),
percent = survey_mean(vartype = c("se", "ci"))
)
school_attendance_region
school_attendance_region %>% group_by(PUMA_region) %>% summarize(n = n_distinct(PUMA))
school_attendance_region %>% group_by(PUMA_region) %>% summarize(n = n_distinct(PUMA), total = sum(n))
school_attendance_region %>% group_by(PUMA_region) %>% summarize(n = n_distinct(PUMA), total = sum(total))
school_attendance_region %>% filter(oy_flag == "connected_youth")
school_attendance_region %>% filter(oy_flag == "connected_youth") %>% group_by(PUMA_region) %>% summarize(total = sum(total))
school_attendance_region %>% group_by(PUMA_region) %>% summarize(n = n_distinct(PUMA), total = sum(total))
school_attendance_region %>%
filter(!(oy_flag %in% c("everyone_else", "opp_youth"))) %>%
ggplot(aes(x = PUMA_region, y = percent, fill = school_label, group = school_label)) +
geom_col(position = 'dodge') +
# facet_wrap(~ oy_flag) +
geom_errorbar(aes(ymin = percent_low, ymax = percent_upp),
position = position_dodge(width = .9),
width = .2)+
labs(y = "Percent",
fill = "School Attendance",
x = "Chicago Region") +
scale_x_discrete(labels = school_attendance_region_label) +
scale_y_continuous(labels = scales::percent)  +
theme_classic()
school_attendance_region\
school_attendance_region
school_attendance_region %>%
filter(oy_flag == "opp_youth")) %>%
ggplot(aes(x = PUMA_region, y = percent, fill = school_label, group = school_label)) +
geom_col(position = 'dodge') +
# facet_wrap(~ oy_flag) +
geom_errorbar(aes(ymin = percent_low, ymax = percent_upp),
position = position_dodge(width = .9),
width = .2)+
labs(y = "Percent",
fill = "School Attendance",
x = "Chicago Region") +
scale_x_discrete(labels = school_attendance_region_label) +
scale_y_continuous(labels = scales::percent)  +
theme_classic()
school_attendance_region %>%
filter(oy_flag == "opp_youth") %>%
ggplot(aes(x = PUMA_region, y = percent, fill = school_label, group = school_label)) +
geom_col(position = 'dodge') +
# facet_wrap(~ oy_flag) +
geom_errorbar(aes(ymin = percent_low, ymax = percent_upp),
position = position_dodge(width = .9),
width = .2)+
labs(y = "Percent",
fill = "School Attendance",
x = "Chicago Region") +
scale_x_discrete(labels = school_attendance_region_label) +
scale_y_continuous(labels = scales::percent)  +
theme_classic()
school_attendance_region %>%
filter(oy_flag == "connected_youth") %>%
ggplot(aes(x = PUMA_region, y = percent, fill = school_label, group = school_label)) +
geom_col(position = 'dodge') +
# facet_wrap(~ oy_flag) +
geom_errorbar(aes(ymin = percent_low, ymax = percent_upp),
position = position_dodge(width = .9),
width = .2)+
labs(y = "Percent",
fill = "School Attendance",
x = "Chicago Region") +
scale_x_discrete(labels = school_attendance_region_label) +
scale_y_continuous(labels = scales::percent)  +
theme_classic()
school_attendance_region <-
pums_survey %>%
group_by(PUMA_region, oy_flag, school_label) %>%
summarize(
total = survey_total(vartype = c("se", "ci")),
percent = survey_mean(vartype = c("se", "ci"))
)
school_attendance_region %>%
filter(oy_flag == "connected_youth") %>%
ggplot(aes(x = PUMA_region, y = percent, fill = school_label, group = school_label)) +
geom_col(position = 'dodge') +
# facet_wrap(~ oy_flag) +
geom_errorbar(aes(ymin = percent_low, ymax = percent_upp),
position = position_dodge(width = .9),
width = .2)+
labs(y = "Percent",
fill = "School Attendance",
x = "Chicago Region") +
scale_x_discrete(labels = school_attendance_region_label) +
scale_y_continuous(labels = scales::percent)  +
theme_classic()
school_youth_attendance %>%
filter(oy_flag != "everyone_else") %>%
ggplot(aes(x = PUMA, y = percent, fill = school_label, group = school_label)) +
geom_col(position = 'dodge') +
geom_errorbar(aes(ymin = percent_low, ymax = percent_upp),
width = .2,
position = position_dodge(width = 1)) +
theme_classic() +
scale_y_continuous(labels = scales::percent) +
scale_x_discrete(labels = school_youth_attendance_labels) +
labs(fill = "School Attendance Status",
y = "Percent")
git status
tidycensus::to_survey
ls()
source(
here::here(
'R',
'script_setup.R'
)
)
# for a lot of these variables, we're interested in much of the same thing
# counts
# and proportions
#
# this is a wrapper around srvyr functions to generate those estimates
create_estimate <- function(pums_survey, ...){
pums_survey %>%
group_by(...) %>%
summarize(
n = survey_total(vartype = c('ci', 'se')),
percent = survey_mean(vartype = c('ci', 'se'))
)
}
# for whatever reason, if I was trying to generate a point estimate on a numeric
# variable, I couldn't use survey_total so I had to have this separate
numeric_estimate <- function(pums_survey, count_col, ...){
pums_survey %>%
group_by(...) %>%
summarize(
percent = survey_mean(x = {{count_col}}, vartype = c('se', 'ci'))
)
}
# RUN ---------------------------------------------------------------
message("Loading PUMS data")
pums_df <-
load_data$load_clean_pums()
pums_df$HISPEED_label
pums_df %>% count(HISPEED_label, wt = PWGTP)
pums_df %>% group_by(SERIALNO) %>% summarize(n = n_distinct(HISPEED_label)) %>% filter(n > 1)
pums_df %>%
filter(chicago_puma_flag) %>%
distinct(SERIALNO, .keep_all = TRUE) %>%
group_by(oy_household_full) %>%
count(HISPEED_label, wt = WGTP)
pums_df %>%
filter(chicago_puma_flag) %>%
distinct(SERIALNO, .keep_all = TRUE) %>%
group_by(oy_household_full) %>%
count(HISPEED_label, wt = WGTP) %>%
mutate(percent = n / sum(n))
pums_df %>%
filter(chicago_puma_flag) %>%
distinct(SERIALNO, .keep_all = TRUE) %>%
group_by(oy_household_full) %>%
count(HISPEED_label, wt = WGTP) %>%
mutate(percent = n / sum(n)) %>%
ggplot(aes(x = oy_household_full, y = percent, fill = HISPEED_label)) +
geom_col()
pums_variables %>% filter(str_detect(var_label, 'computer'))
pums_variables %>% filter(str_detect(var_label, 'computer')) %>% distinct(var_code, var_label)
pums_variables %>% filter(str_detect(var_label, 'laptop')) %>% distinct(var_code, var_label)
pums_df$LAPTOP_label %>% unique()
pums_df %>%
filter(chicago_puma_flag) %>%
distinct(SERIALNO, .keep_all = TRUE) %>%
group_by(oy_household_full) %>%
count(LAOPTOP_label, wt = WGTP) %>%
mutate(percent = n / sum(n)) %>%
ggplot(aes(x = oy_household_full, y = percent, fill = HISPEED_label)) +
geom_col()
pums_df %>%
filter(chicago_puma_flag) %>%
distinct(SERIALNO, .keep_all = TRUE) %>%
group_by(oy_household_full) %>%
count(LAPTOP_label, wt = WGTP) %>%
mutate(percent = n / sum(n)) %>%
ggplot(aes(x = oy_household_full, y = percent, fill = HISPEED_label)) +
geom_col()
pums_df %>%
filter(chicago_puma_flag) %>%
distinct(SERIALNO, .keep_all = TRUE) %>%
group_by(oy_household_full) %>%
count(LAPTOP_label, wt = WGTP) %>%
mutate(percent = n / sum(n)) %>%
ggplot(aes(x = oy_household_full, y = percent, fill = LAPTOP_label)) +
geom_col()
ls()
pums_df <-
pums_df %>%
mutate(
across(
.cols = c(oy_flag,
child_flag,
age_bracket,
alt_age_bracket,
race_ethnicity,
race_alternate,
income_bracket,
commute_bracket,
oy_hh_flag,
head_hh_flag,
school_attainment,
oy_household,
oy_household_full,
PUMA_region,
contains('label')),
factor))
## FOR PERSON-LEVEL ESTIMATES
pums_survey <-
convert_to_survey(pums_data = pums_df) %>%
# to limit to city of Chicago PUMAs
filter(chicago_puma_flag == TRUE)
# FOR HOUSEHOLD-LEVEL ESTIMATES
pums_hh_survey <-
pums_df %>%
filter(chicago_puma_flag) %>%
distinct(SERIALNO,.keep_all = TRUE) %>%
to_survey(df = .,
type = 'housing',
class = 'srvyr',
design = 'rep_weights')
pums_hh_survey %>%
group_by(oy_household_full, HISPEED_label) %>%
summarize(percent = survey_mean(vartype = c('se', 'ci')),
n = survey_total(vartype = c('se','ci')))
create_estimate
analysis_data$LAPTOP <-
pums_hh_survey %>%
create_estimate(pums_survey = .,
oy_household_full, HISPEED_label)
test <-
pums_hh_survey %>%
create_estimate(pums_survey = .,
oy_household_full, HISPEED_label)
test
rm(list = ls())
