filter(.data = ., SERIALNO %in% pums_counter(2)) %>% View()
pums_df %>% filter(SERIALNO %in% pums_counter(17)) %>% select(SERIALNO, SPORDER, RELP_label)
pums_df %>% filter(SERIALNO %in% pums_counter(17)) %>% select(SERIALNO, SPORDER, RELP_label NOC)
pums_df %>% filter(SERIALNO %in% pums_counter(17)) %>% select(SERIALNO, SPORDER, RELP_label ,NOC)
pums_df %>% filter(SERIALNO %in% pums_counter(16)) %>% select(SERIALNO, SPORDER, RELP_label ,NOC)
pums_df %>% filter(SERIALNO %in% pums_counter(15)) %>% select(SERIALNO, SPORDER, RELP_label ,NOC)
pums_df %>% filter(SERIALNO %in% pums_counter(14)) %>% select(SERIALNO, SPORDER, RELP_label ,NOC)
pums_df %>% filter(SERIALNO %in% pums_counter(14)) %>% select(SERIALNO, SPORDER, RELP_label ,NOC) %>% View()
pums_df %>% filter(SERIALNO %in% pums_counter(14)) %>% select(SERIALNO, SPORDER, RELP_label ,NOC, oy_flag) %>% View()
pums_df %>% filter(SERIALNO %in% pums_counter(14)) %>% select(SERIALNO, SPORDER, RELP_label ,NOC, oy_flag, AGEP) %>% View()
pums_counter <- function(x){
pums_df %>%
count(SERIALNO, sort = TRUE) %>%
filter(n <= x) %>%
pull(SERIALNO)
}
pums_df %>% filter(oy_flag == "opp_youth", SERIALNO %in% pums_counter(14)) %>% select(SERIALNO, SPORDER, RELP_label ,NOC, oy_flag, AGEP) %>% View()
pums_df %>% group_by(SERIALNO) %>% filter(any(oy_flag == "opp_youth"))
pums_df %>% group_by(SERIALNO) %>% filter(any(oy_flag == "opp_youth")) %>% dim()
pums_df %>% group_by(SERIALNO) %>% filter(any(oy_flag == "opp_youth")) %>% View()
pums_df %>% group_by(SERIALNO) %>% filter(any(oy_flag == "opp_youth")) %>% select(SERIALNO, SPORDER, RELP_label, NOC, AGEP) %>% View()
pums_df %>% group_by(SERIALNO) %>% filter(any(oy_flag == "opp_youth")) %>% select(SERIALNO, SPORDER, RELP_label, NOC, AGEP) %>% arrange(SERIALNO) %>% View()
pums_df %>% arrange(SERIALNO) %>% group_by(SERIALNO) %>% filter(any(oy_flag == "opp_youth")) %>% select(SERIALNO, SPORDER, RELP_label, NOC, AGEP) %>% View()
pums_df %>% arrange(SERIALNO) %>% group_by(SERIALNO) %>% filter(any(oy_flag == "opp_youth")) %>% select(SERIALNO, SPORDER, RELP_label, NOC, AGEP, oy_flag) %>% View()
pums_df %>% arrange(SERIALNO) %>% group_by(SERIALNO) %>% filter(any(oy_flag == "opp_youth")) %>% select(SERIALNO, SPORDER, RELP_label, NOC, AGEP, ESR_label, SCH_label, oy_flag) %>% View()
pums_df %>% group_by(SERIALNO) %>% filter(any(oy_flag == "opp_youth")) %>% select(SERIALNO, SPORDER, RELP_label, NOC, AGEP, ESR_label, SCH_label, oy_flag) %>% ungroup() %>% arrange(SERIALNO) %>%  View()
pums_df %>% group_by(SERIALNO) %>% filter(any(oy_flag == "opp_youth")) %>% select(SERIALNO, SPORDER, RELP_label, NOC, AGEP, oy_flag, ESR_label, SCH_label) %>% ungroup() %>% arrange(SERIALNO) %>%  View()
record_filter <- function(rec){
pums_df %>%
filter(SERIALNO == rec) %>%
select(SERIALNO, SPORDER, RELP_label, NOC, AGEP, oy_flag, ESR_label, SCH_label)
}
rec_fil <- function(rec){
pums_df %>%
filter(SERIALNO == rec) %>%
select(SERIALNO, SPORDER, RELP_label, NOC, AGEP, oy_flag, ESR_label, SCH_label)
}
rec_fil("	2018HU1396696")
rec_fil("2018HU1396696")
rec_fil("2018HU1396696") %>% View()
view_oy <- function(){
pums_df %>%
group_by(SERIALNO) %>%
filter(any(oy_flag == "opp_youth")) %>%
select(SERIALNO, SPORDER, RELP_label, NOC, AGEP, oy_flag, ESR_label, SCH_label) %>%
View()
}
view_oy()
view_oy <- function(){
pums_df %>%
group_by(SERIALNO) %>%
filter(any(oy_flag == "opp_youth")) %>%
select(SERIALNO, SPORDER, RELP_label, NOC, AGEP, oy_flag, ESR_label, SCH_label)
}
view_oy <- function(){
pums_df %>%
group_by(SERIALNO) %>%
filter(any(oy_flag == "opp_youth")) %>%
select(SERIALNO, SPORDER, RELP_label, NOC, AGEP, oy_flag, ESR_label, SCH_label) %>%
filter(NOC > 1)
}
view_oy() %>% View()
pums_df %>%
group_by(SERIALNO) %>%
filter(any(oy_flag == "opp_youth")) %>%
select(SERIALNO, SPORDER,oy_flag, RELP_label, NOC, AGEP, ESR_label, SCH_label) %>%
filter(NOC > 1)
view_oy <- function(){
pums_df %>%
group_by(SERIALNO) %>%
filter(any(oy_flag == "opp_youth")) %>%
select(SERIALNO, SPORDER,oy_flag, RELP_label, NOC, AGEP, ESR_label, SCH_label) %>%
filter(NOC > 1)
}
view_oy() %>% View()
pums_df$RELP_label %>% unique()
pums_vars("SPORDER")
pums_df %>% distinct(RELP_label, SPORDER)
pums_df$RELP_label %>% unique()
view_oy <- function(){
pums_df %>%
group_by(SERIALNO) %>%
filter(any(oy_flag == "opp_youth")) %>%
select(SERIALNO, SPORDER,oy_flag, RELP_label, NOC, AGEP, ESR_label, SCH_label) %>%
filter(NOC > 1) %>%
group_by(SERIALNO) %>%
arrange(-AGEP)
}
view_oy() %>% View()
pums_df %>%
group_by(SERIALNO) %>%
filter(any(oy_flag == "opp_youth")) %>%
select(SERIALNO, SPORDER,oy_flag, RELP_label, NOC, AGEP, ESR_label, SCH_label) %>%
filter(NOC > 1) %>%
group_by(SERIALNO) %>%
arrange(SERIALNO, -AGEP)
view_oy <- function(){
pums_df %>%
group_by(SERIALNO) %>%
filter(any(oy_flag == "opp_youth")) %>%
select(SERIALNO, SPORDER,oy_flag, RELP_label, NOC, AGEP, ESR_label, SCH_label) %>%
filter(NOC > 1) %>%
group_by(SERIALNO) %>%
arrange(SERIALNO, -AGEP)
}
view_oy() %>% View()
pums_def <- function(def){
tidycensus::pums_variables %>%
filter(str_detect(var_label, pattern = var)) %>%
distinct(var_code, var_label)
}
pums_def('birth')
pums_def <- function(def){
tidycensus::pums_variables %>%
filter(str_detect(var_label, pattern == var)) %>%
distinct(var_code, var_label)
}
pums_def('birth')
pums_def <- function(def){
tidycensus::pums_variables %>%
filter(str_detect(var_label, pattern == def)) %>%
distinct(var_code, var_label)
}
pums_def('birth')
pums_def <- function(def){
tidycensus::pums_variables %>%
filter(str_detect(var_label, pattern = def)) %>%
distinct(var_code, var_label)
}
pums_def('birth')
view_oy() %>% filter(SERIALNO == "2018HU0014551") %>% View()
pums_df %>% group_by(oy_flag, head_hh_flag) %>% count()
pums_df %>% group_by(oy_flag, head_hh_flag) %>% count(wt = PWGTP)
pums_df %>% filter(chicago_puma_flag) %>% group_by(oy_flag, head_hh_flag) %>% count(wt = PWGTP)
view_oy() %>% dim()
view_oy() %>% count(oy_flag, wt = PWGTP)
view_oy()
view_oy <- function(){
pums_df %>%
group_by(SERIALNO) %>%
filter(any(oy_flag == "opp_youth")) %>%
select(SERIALNO, SPORDER,oy_flag, RELP_label, NOC, AGEP, ESR_label, SCH_label, PWGTP) %>%
filter(NOC > 1) %>%
group_by(SERIALNO) %>%
arrange(SERIALNO, -AGEP)
}
view_oy()
view_oy() %>% count(oy_flag)
view_oy() %>% ungroup() %>% count(oy_flag)
pums_df %>% filter(oy_flag == "opp_youth", head_hh_flag)
select_vars <- c("SERIALNO",
"SPORDER",
"oy_flag",
"RELP_label"," NOC", "AGEP", "ESR_label", "SCH_label", "PWGTP")
pums_df %>% filter(oy_flag == "opp_youth", head_hh_flag) %>% count(PWGTP)
pums_df %>% filter(oy_flag == "opp_youth", head_hh_flag) %>% count()
pums_df %>% filter(oy_flag == "opp_youth", head_hh_flag) %>% count(wt = PWGTP)
pums_df %>% filter(chicago_puma_flag) %>% filter(oy_flag == "opp_youth", head_hh_flag) %>% count(wt = PWGTP)
view_oy()
view_oy() %>% count(oy_flag)
view_oy() %>% ungroup() %>% count(oy_flag, wt = PWGTP)
pums_df %>% count(oy_flag)
pums_df %>% count(oy_flag, wt = PWGTP)
pums_df %>% filter(oy_hh_flag)
pums_df$oy_hh_flag
pums_df$oy_hh_flag %>% unique()
pums_df %>% filter(oy_hh_flag == "Opportunity Youth _ HH")
pums_df %>% filter(oy_hh_flag == "Opportunity Youth - HH")
pums_df %>% filter(oy_hh_flag == "Opportunity Youth - HH") %>% select(select_vars) %>% View()
select_vars <- c("SERIALNO",
"SPORDER",
"oy_flag",
"RELP_label","NOC", "AGEP", "ESR_label", "SCH_label", "PWGTP")
pums_df %>% filter(oy_hh_flag == "Opportunity Youth - HH") %>% select(select_vars) %>% View()
pums_df %>% group_by(SERIALNO) %>% filter(any(oy_hh_flag == "Opportunity Youth - HH"))
pums_df %>% group_by(SERIALNO) %>% filter(any(oy_hh_flag == "Opportunity Youth - HH")) %>% pull(SERIALNO) %>% n_distinct()
pums_df %>% group_by(SERIALNO) %>% filter(any(oy_hh_flag == "Opportunity Youth - HH")) %>% select(select_vars) %>% View()
pums_df %>% group_by(SERIALNO) %>% filter(any(oy_hh_flag == "Opportunity Youth - HH")) %>% select(select_vars) %>% filter(NOC > 0) %>%  View()
pums_var('oc')
pums_vars("OC")
ls()
load_data <-
list(
download_pums_data = function(){
# api_key =
#   get_api_key()
tidycensus::get_pums(
# key = api_key,
variables = get_pums_variables(),
state = 'IL',
recode = TRUE,
year = 2018,
survey = 'acs1',
rep_weights = 'person'
)
},
load_pums_data = function(){
file_path =
here::here('raw_data',
'il_pums_data.csv')
file =
readr::read_csv(file_path)
},
load_PUMA_crosswalk = function(){
file_path =
here::here(
'raw_data',
'MSA2013_PUMA2010_crosswalk.csv')
file =
readr::read_csv(file_path)
},
load_clean_pums = function(){
file_path =
here::here(
'clean_data',
'il_pums_data_clean.csv'
)
file =
readr::read_csv(file_path)
},
load_population_estimates = function(){
file_path =
here::here(
'analysis_data',
'oy_population_estimates.RDS'
)
file =
readr::read_rds(file_path)
}
)
pums_df <- load_data$load_clean_pums()
names(pums_df)
pums_df$OC_label %>% unique()
pums_df %>% arrange(SERIALNO) %>% select(NOC, OC_label) %>% head(20) %>% View()
pums_df %>% distinct(NOC< OC_label)
pums_df %>% distinct(NOC, OC_label)
pums_df %>% filter(NOC > 0) %>% arrange(SERIALNO) %>% head(1000) %>% View()
pums_df$FER_label
pums_df$FER_label %>% unique()
select_vars <- c("SERIALNO",
"SPORDER",
"oy_flag",
"RELP_label","NOC", "OC", "AGEP", "FER_label", "ESR_label", "SCH_label", "PWGTP")
pums_df %>% filter(NOC > 0) %>% arrange(SERIALNO) %>% head(1000) %>% select(select_vars) %>% View()
select_vars <- c("SERIALNO",
"SPORDER",
"oy_flag",
"RELP_label","NOC", "OC_label", "AGEP", "FER_label", "ESR_label", "SCH_label", "PWGTP")
pums_df %>% filter(NOC > 0) %>% arrange(SERIALNO) %>% head(1000) %>% select(select_vars) %>% View()
ls()
pums_vars('MOMLOC')
pums_df %>% filter(NOC > 0) %>% arrange(SERIALNO) %>% head(1000) %>% select(select_vars, "OC") %>% View()
pums_df %>%
filter(NOC >= 0) %>%
group_by(NOC) %>%
summarize(n = sum(OC))
class(pums_df$OC)
pums_df$OC %>% unique()
pums_df %>%
filter(NOC >= 0, OC != "b") %>%
mutate(OC = as.double(OC)) %>%
group_by(NOC) %>%
summarize(n = sum(OC))
pums_df %>%
filter(NOC >= 0, OC != "b") %>%
mutate(OC = as.double(OC)) %>%
group_by(SERIALNO,NOC) %>%
summarize(n = sum(OC))
pums_df %>%
filter(NOC >= 0, OC != "b") %>%
mutate(OC = as.double(OC)) %>%
group_by(SERIALNO,NOC) %>%
summarize(n = sum(OC)) %>%
filter(NOC != n)
pums_df %>%
filter(NOC >= 0, OC != "b") %>%
mutate(OC = as.double(OC)) %>%
group_by(SERIALNO,NOC) %>%
summarize(n = sum(OC)) %>%
filter(NOC > 1)
pums_df %>%
filter(NOC >= 0, OC != "b") %>%
mutate(OC = as.double(OC)) %>%
group_by(SERIALNO,NOC) %>%
summarize(n = sum(OC)) %>%
filter(NOC > 0)
packageVersion('rmarkdown')
ls)()
ls()
ls()
rm(list = ls())
knitr::opts_chunk$set(echo = FALSE,
warning = F,
message = F,
fig.height = 4,
fig.width = 8)
source(
here::here(
'R',
'presentation_setup.R'
)
)
analysis_data <-
load_data$load_population_estimates()[['q2_household']]
# analysis_data <-
#   modify(.x = analysis_data,
#          .f = ~.x %>% mutate(oy_flag = figure_helpers$format_oy_variable(oy_flag)))
analysis_data <-
map(
.x = analysis_data,
.f = ~
.x %>%
modify_at(.x = .,
.at = 'oy_flag',
.f = figure_helpers$format_oy_variable) %>%
modify_at(.x = .,
.at = 'oy_hh_flag',
.f = figure_helpers$format_oy_hh_variable))
erase_y_axis =
theme(
axis.text.y = element_blank(),
axis.line.y = element_blank(),
axis.title.y = element_blank(),
axis.ticks.y = element_blank()
)
erase_x_legend =
theme(
axis.title.x = element_blank()
)
# Settings for the lower error bar
# other option is percent_low
error_bar_setting <-
rlang::sym('percent')
# color contrasts between Connected Youth and Opportunity Youth
# color_contrast <-
#   c(`Connected Youth` = "#800000", `Opportunity Youth` = '#D5802B')
color_contrast <-
c(`Connected Youth` = "#767676", `Opportunity Youth` = '#D5802B')
color_contrast_alt <- color_contrast
names(color_contrast_alt) <- NULL
color_palette <-
ggsci::pal_uchicago(palette = 'default')
color_palette_light <-
ggsci::pal_uchicago(palette = 'light')
basic_plot <- function(data, fill_label = NULL){
fill_col = names(data)[2] %>% rlang::sym()
x_col =    names(data)[str_detect(names(data), "oy")] %>% rlang::sym()
data %>%
filter(!str_detect(!!x_col, '(Everyone)|(Eveyrone)')) %>%
ggplot(aes(x = !!x_col, y = percent, fill = !!fill_col)) +
geom_col(color = 'black') +
geom_text(aes(label = if_else(percent > .05,
scales::percent(percent, accuracy = .1),
""),
group = !!fill_col),
position = position_stack(vjust = .5)) +
theme_classic() +
scale_y_continuous(labels = scales::percent) +
erase_y_axis +
erase_x_legend +
theme(axis.text.x = element_text(face = 'bold')) +
labs(
caption = "Cells representing less than 5% suppressed for clarity") +
ggsci::scale_fill_uchicago()
}
single_plot <- function(data, x_col = NULL){
if(is.null(x_col)){
x_col =    names(data)[str_detect(names(data), "oy")] %>% rlang::sym()
}else{
x_col = rlang::sym(x_col)
}
data %>%
ggplot(aes(x = !!x_col, y = percent)) +
geom_col(color = 'black',
fill = color_contrast[2]) +
geom_errorbar(aes(ymax = percent_upp, ymin = !!error_bar_setting),
width = .2) +
theme_classic() +
geom_text(aes(label = scales::percent(percent, digits = 3)),
position = position_stack(vjust = .5)) +
# labs( y = "Average Number of Children") +
erase_x_legend +
theme(axis.text.x = element_text(face = 'bold')) +
labs(
caption = "Cells representing less than 5% suppressed for clarity"
)
}
wrap_x_labels =
scale_x_discrete(labels = function(x) str_wrap(x,10))
analysis_data$head_of_household_alt %>%
single_plot(x_col = 'oy_hh_flag') +
wrap_x_labels +
scale_y_continuous(labels = scales::percent) +
labs(caption = "",
y = "Percent") +
erase_y_axis
analysis_data$hh_children %>%
basic_plot() +
labs(fill = "Parental Status") +
wrap_x_labels +
scale_fill_manual(values = color_contrast_alt)
analysis_data$hh_num_children %>%
filter(!str_detect(oy_hh_flag, 'Eve')) %>%
ggplot(aes(x = oy_hh_flag, y = percent)) +
geom_col(color = 'black',
fill = color_contrast[2]) +
geom_errorbar(aes(ymax = percent_upp, ymin = !!error_bar_setting),
width = .2) +
theme_classic() +
geom_text(aes(label = round(percent, digits = 2)),
position = position_stack(vjust = .5)) +
# labs( y = "Average Number of Children") +
erase_x_legend +
theme(axis.text.x = element_text(face = 'bold')) +
labs(caption = "Cells representing less than 5% suppressed for clarity",
y = 'Average number of children') +
wrap_x_labels
analysis_data$hh_average_income %>%
filter(!(str_detect(oy_hh_flag, "Eve"))) %>%
ggplot(aes(x = oy_hh_flag, y = percent)) +
geom_col(color = 'black',
fill = color_contrast[2]) +
geom_errorbar(aes(ymax = percent_upp, ymin = !!error_bar_setting),
width = .2) +
theme_classic() +
geom_text(aes(label = scales::dollar(percent)),
position = position_stack(vjust = .5),
size = 3.7) +
# labs( y = "Average Number of Children") +
erase_x_legend +
theme(axis.text.x = element_text(face = 'bold')) +
labs(
y = "Person's total income",
caption = "Cells representing less than 5% suppressed for clarity"
) +
wrap_x_labels +
scale_y_continuous(labels = scales::dollar)
analysis_data$hh_food_stamps %>%
basic_plot() +
labs(fill = "Food Stamp Recipient") +
wrap_x_labels +
scale_fill_manual(values = color_contrast_alt)
analysis_data$hh_type %>%
basic_plot() +
labs(fill = "Type of Household") +
scale_fill_manual(values = c(color_contrast[2], color_palette_light(8)))
analysis_data$hh_workers_in_fam %>%
basic_plot() +
labs(fill = "Number of workers in Family") +
wrap_x_labels +
scale_fill_manual(values = c(color_contrast_alt[2], color_palette_light(4)))
analysis_data$hh_married %>%
basic_plot() +
labs(fill = "Marital Status") +
wrap_x_labels  +
scale_fill_manual(values = c(color_contrast_alt[2], rev(color_palette(5))))
analysis_data$hh_partnered %>%
basic_plot() +
labs(fill = "Partner Status") +
wrap_x_labels
analysis_data$hh_same_sex_married %>%
basic_plot() +
labs(fill = "Same-Sex Married Household") +
wrap_x_labels
analysis_data$hh_multigen %>%
basic_plot() +
labs(fill = "Multigenerational Family") +
wrap_x_labels
analysis_data$hh_migration %>%
basic_plot() +
labs(fill = "Migration Status") +
wrap_x_labels +
scale_fill_manual(values = c(color_palette(3), color_contrast_alt[2]))
analysis_data$hh_transportation_mode %>%
mutate(JWTR_label = str_remove(JWTR_label, "\\(.*\\)")) %>%
basic_plot() +
labs(fill = "Mode of Transport") +
wrap_x_labels +
scale_fill_manual(values = c(color_palette(9), color_palette_light(9)))
analysis_data$hh_commute_bracket %>%
basic_plot() +
labs(fill = "Commute Time (minutes)") +
wrap_x_labels +
scale_fill_manual(values = c(color_contrast_alt[2], color_palette(9), color_palette_light(1)))
ls9)
analysis_data
analysis_data %>% names()
analysis_data %>% map(.f = ~ .x %>% filter_at(.vars = vars(matches('oy_hh_flag'))))
aanalysis_data %>% map(.f = ~ .x %>% filter(across(one_of('oy_hh_flag', 'oy_flag'))))
analysis_data %>% map(.f = ~ .x %>% filter(across(one_of('oy_hh_flag', 'oy_flag'))))
analysis_data %>% map(.f = ~ .x %>% filter(across(.cols = one_of('oy_flag', 'oy_hh_flag'))))
analysis_data %>% map(.f = ~ .x %>% filter(across(everything(), ~ !str_detect(.x, "Everyone"))))
analysis_data$head_of_household_alt %>%
filter(!str_detect(oy_hh_flag, "Everyone")) %>%
single_plot(x_col = 'oy_hh_flag') +
wrap_x_labels +
scale_y_continuous(labels = scales::percent) +
labs(caption = "",
y = "Percent") +
erase_y_axis
analysis_data$head_of_household_alt %>%
filter(!str_detect(oy_hh_flag, "Eve")) %>%
single_plot(x_col = 'oy_hh_flag') +
wrap_x_labels +
scale_y_continuous(labels = scales::percent) +
labs(caption = "",
y = "Percent") +
erase_y_axis
sum(1:260)
sum(1:26)
ls()
ls()
