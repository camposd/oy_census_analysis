---
title: "Household Structure (Preliminary)"
author: "Diego Campos"
date: "10/8/2020"
output: powerpoint_presentation
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      warning = F, 
                      message = F, 
                      fig.height = 4, 
                      fig.width = 8)
```

```{r load-libraries-functions}

source(
  here::here(
    'R', 
    'presentation_setup.R'
  )
)


```

```{r load-data}

analysis_data <- 
  load_data$load_population_estimates()[['q2_household']]




```

```{r}
# analysis_data <- 
#   modify(.x = analysis_data, 
#          .f = ~.x %>% mutate(oy_flag = figure_helpers$format_oy_variable(oy_flag)))

analysis_data <- 
  map(
    .x = analysis_data, 
    .f = ~ 
      .x %>% 
      modify_at(.x = ., 
                .at = 'oy_flag', 
                .f = figure_helpers$format_oy_variable) %>% 
      modify_at(.x = ., 
                .at = 'oy_hh_flag', 
                .f = figure_helpers$format_oy_hh_variable))




erase_y_axis = 
   theme(
    axis.text.y = element_blank(), 
    axis.line.y = element_blank(), 
    axis.title.y = element_blank(), 
    axis.ticks.y = element_blank()
  )

erase_x_legend = 
  theme(
    axis.title.x = element_blank()
  )


# Settings for the lower error bar
# other option is percent_low
error_bar_setting <- 
  rlang::sym('percent')

# color contrasts between Connected Youth and Opportunity Youth
# color_contrast <- 
#   c(`Connected Youth` = "#800000", `Opportunity Youth` = '#D5802B')

color_contrast <- 
  c(`Connected Youth` = "#767676", `Opportunity Youth` = '#D5802B')

color_contrast_alt <- color_contrast
names(color_contrast_alt) <- NULL

color_palette <- 
  ggsci::pal_uchicago(palette = 'default')

color_palette_light <- 
  ggsci::pal_uchicago(palette = 'light')
  


```

```{r}
basic_plot <- function(data, fill_label = NULL){
  
  fill_col = names(data)[2] %>% rlang::sym()
  
  x_col =    names(data)[str_detect(names(data), "oy")] %>% rlang::sym()
  
  
  
  data %>% 
    filter(!str_detect(!!x_col, '(Everyone)|(Eveyrone)')) %>% 
    ggplot(aes(x = !!x_col, y = percent, fill = !!fill_col)) + 
    geom_col(color = 'black') + 
    geom_text(aes(label = if_else(percent > .05, 
                                  scales::percent(percent, accuracy = .1), 
                                  ""), 
                  group = !!fill_col), 
              position = position_stack(vjust = .5)) +
    theme_classic() + 
    scale_y_continuous(labels = scales::percent) + 

    erase_y_axis + 
    erase_x_legend + 
    theme(axis.text.x = element_text(face = 'bold')) + 
    labs(
      caption = "Cells representing less than 5% suppressed for clarity") + 
    ggsci::scale_fill_uchicago()
    
    
}

single_plot <- function(data, x_col = NULL){
  
  if(is.null(x_col)){
    x_col =    names(data)[str_detect(names(data), "oy")] %>% rlang::sym()
  
  }else{
    x_col = rlang::sym(x_col)
  }
  
  data %>% 
    ggplot(aes(x = !!x_col, y = percent)) + 
    geom_col(color = 'black', 
             fill = color_contrast[2]) + 
    geom_errorbar(aes(ymax = percent_upp, ymin = !!error_bar_setting), 
                  width = .2) + 
    theme_classic() + 
    geom_text(aes(label = scales::percent(percent, digits = 3)), 
              position = position_stack(vjust = .5)) + 
    # labs( y = "Average Number of Children") + 
    erase_x_legend + 
    theme(axis.text.x = element_text(face = 'bold')) + 
    labs(
      caption = "Cells representing less than 5% suppressed for clarity"
    )
}

wrap_x_labels = 
  scale_x_discrete(labels = function(x) str_wrap(x,10))


```

# Research Questions of Interest

* Are Opportunity Youth caring for children?
* What are the household income characteristics of Opportunity Youth?
* Mobility Status

# Heads of Household

```{r}
analysis_data$head_of_household_alt %>% 
  single_plot(x_col = 'oy_hh_flag') + 
  wrap_x_labels + 
  scale_y_continuous(labels = scales::percent) + 
  labs(caption = "", 
       y = "Percent") + 
  erase_y_axis
```


# Do they have children?

```{r}

analysis_data$hh_children %>% 
  basic_plot() + 
  labs(fill = "Parental Status") + 
  wrap_x_labels + 
  scale_fill_manual(values = color_contrast_alt)
  



```

# Number of Children

```{r, eval = T}

analysis_data$hh_num_children %>% 
  filter(!str_detect(oy_hh_flag, 'Eve')) %>% 
  
  ggplot(aes(x = oy_hh_flag, y = percent)) + 
  geom_col(color = 'black', 
           fill = color_contrast[2]) + 
  geom_errorbar(aes(ymax = percent_upp, ymin = !!error_bar_setting), 
                width = .2) + 
  theme_classic() + 
  geom_text(aes(label = round(percent, digits = 2)), 
            position = position_stack(vjust = .5)) + 
  # labs( y = "Average Number of Children") + 
  erase_x_legend + 
  theme(axis.text.x = element_text(face = 'bold')) + 
  labs(caption = "Cells representing less than 5% suppressed for clarity", 
       y = 'Average number of children') + 
  wrap_x_labels 
  



```


# Income Characteristics: Total Person's Income



```{r}

analysis_data$hh_average_income %>% 
  filter(!(str_detect(oy_hh_flag, "Eve"))) %>% 
  ggplot(aes(x = oy_hh_flag, y = percent)) + 
  geom_col(color = 'black', 
           fill = color_contrast[2]) + 
  geom_errorbar(aes(ymax = percent_upp, ymin = !!error_bar_setting), 
                width = .2) + 
  theme_classic() + 
  geom_text(aes(label = scales::dollar(percent)), 
            position = position_stack(vjust = .5), 
            size = 3.7) + 
  # labs( y = "Average Number of Children") + 
  erase_x_legend + 
  theme(axis.text.x = element_text(face = 'bold')) + 
  labs(
    y = "Person's total income",
    caption = "Cells representing less than 5% suppressed for clarity"
  ) + 
  wrap_x_labels + 
  scale_y_continuous(labels = scales::dollar)


```




```{r, eval = F}

# Income Characteristics: Income Bracket

analysis_data$hh_income_bracket %>% 
  # filter(oy_flag != "Everyone Else") %>% 
  basic_plot() + 
  labs(fill = "Income Bracket") + 
  wrap_x_labels + 
  scale_fill_manual(values = c(color_contrast_alt[2],color_palette(9), color_palette_light(9)))


```

# Income Characteristics: Food Stamps


```{r}
analysis_data$hh_food_stamps %>% 
  basic_plot() + 
  labs(fill = "Food Stamp Recipient") + 
  wrap_x_labels + 
  scale_fill_manual(values = color_contrast_alt)


```

# Household Type:

```{r}

analysis_data$hh_type %>% 
  basic_plot() + 
  labs(fill = "Type of Household") + 
  scale_fill_manual(values = c(color_contrast[2], color_palette_light(8)))
  



```


# Household Characteristics: Workers in Family


```{r}
analysis_data$hh_workers_in_fam %>% 
  basic_plot() + 
  labs(fill = "Number of workers in Family") + 
  wrap_x_labels + 
  scale_fill_manual(values = c(color_contrast_alt[2], color_palette_light(4)))
  

```




# Marital Status / Partnered
```{r}

analysis_data$hh_married %>% 
  basic_plot() + 
  labs(fill = "Marital Status") + 
  wrap_x_labels  + 
  scale_fill_manual(values = c(color_contrast_alt[2], rev(color_palette(5))))
  



```

# Partnered

```{r}
analysis_data$hh_partnered %>% 
  basic_plot() + 
  labs(fill = "Partner Status") + 
  wrap_x_labels  
  
```



# Same-sex households

```{r}
analysis_data$hh_same_sex_married %>% 
  basic_plot() + 
  labs(fill = "Same-Sex Married Household") + 
  wrap_x_labels

```

# Multi-generational Families

```{r}

analysis_data$hh_multigen %>% 
  basic_plot() + 
  labs(fill = "Multigenerational Family") + 
  wrap_x_labels




```



# Mobility: Migration

```{r}

analysis_data$hh_migration %>% 
  basic_plot() + 
  labs(fill = "Migration Status") + 
  wrap_x_labels + 
  scale_fill_manual(values = c(color_palette(3), color_contrast_alt[2]))

```

# Mobility: Mode of Transportation
```{r}

analysis_data$hh_transportation_mode %>% 
  mutate(JWTR_label = str_remove(JWTR_label, "\\(.*\\)")) %>% 
  basic_plot() + 
  labs(fill = "Mode of Transport") + 
  wrap_x_labels + 
  scale_fill_manual(values = c(color_palette(9), color_palette_light(9)))

```

# Migration: Average Commute Time

```{r}

analysis_data$hh_commute_bracket %>% 
  basic_plot() + 
  labs(fill = "Commute Time (minutes)") + 
  wrap_x_labels + 
  scale_fill_manual(values = c(color_contrast_alt[2], color_palette(9), color_palette_light(1)))



```





