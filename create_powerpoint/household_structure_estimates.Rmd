---
title: "Household Structure (Preliminary)"
author: "Diego Campos"
date: " `r format(Sys.Date(), '%B %d, %Y')`"
output: 
  powerpoint_presentation:
      reference_doc: reference_ppt.pptx
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      warning = F, 
                      message = F, 
                      fig.height = 4, 
                      fig.width = 8)
```

```{r load-libraries-functions}

source(
  here::here(
    'R', 
    'presentation_setup.R'
  )
)


```

```{r load-data}

analysis_data <- 
  load_data$load_population_estimates()[c('q2_household', 'household_income_estimates')]

ipums_data <- 
  load_data$load_IPUMS_population_estimates()




```

```{r}


analysis_data <-
  map(
    .x = analysis_data,
    .f = ~
      .x %>%
      modify_at(.x = .,
                .at = 'oy_flag',
                .f = figure_helpers$format_oy_variable) %>%
      modify_at(.x = .,
                .at = 'oy_hh_flag',
                .f = figure_helpers$format_oy_hh_variable))

analysis_data$q2_household <- 
  map(analysis_data$q2_household, 
      .f = ~ 
        .x %>%
              modify_at(.x = .,
                .at = 'oy_flag',
                .f = figure_helpers$format_oy_variable))

# analysis_data <- 
#   analysis_data %>% map(.f = ~ .x %>% filter(across(everything(), ~ !(str_detect(.x, "Every")))))

erase_y_axis = 
   theme(
    axis.text.y = element_blank(), 
    axis.line.y = element_blank(), 
    axis.title.y = element_blank(), 
    axis.ticks.y = element_blank()
  )

erase_x_legend = 
  theme(
    axis.title.x = element_blank()
  )


# Settings for the lower error bar
# other option is percent_low
error_bar_setting <- 
  rlang::sym('percent')

# color contrasts between Connected Youth and Opportunity Youth
# color_contrast <- 
#   c(`Connected Youth` = "#800000", `Opportunity Youth` = '#D5802B')

color_contrast <- 
  c(`Connected Youth` = "#767676", `Opportunity Youth` = '#D5802B')

color_contrast_alt <- color_contrast
names(color_contrast_alt) <- NULL

color_contrast_hh <- rep(color_contrast, 2)
names(color_contrast_hh) <- c("Connected Youth - HH", "Connected Youth - Non-HH", "Opportunity Youth - HH", "Opportunity Youth - Non-HH" )

color_palette <- 
  ggsci::pal_uchicago(palette = 'default')

color_palette_light <- 
  ggsci::pal_uchicago(palette = 'light')
  


```

```{r}
basic_plot <- function(data, fill_label = NULL){
  
  fill_col = names(data)[2] %>% rlang::sym()
  
  x_col =    names(data)[str_detect(names(data), "oy")] %>% rlang::sym()
  
  
  
  data %>% 
    filter(!str_detect(!!x_col, '(Everyone)|(Eveyrone)')) %>% 
    ggplot(aes(x = !!x_col, y = percent, fill = !!fill_col)) + 
    geom_col(color = 'black') + 
    geom_text(aes(label = if_else(percent > .05, 
                                  scales::percent(percent, accuracy = .1), 
                                  ""), 
                  group = !!fill_col), 
              position = position_stack(vjust = .5)) +
    theme_classic() + 
    scale_y_continuous(labels = scales::percent) + 

    erase_y_axis + 
    erase_x_legend + 
    theme(axis.text.x = element_text(face = 'bold')) + 
    labs(
      caption = "Cells representing less than 5% suppressed for clarity") + 
    ggsci::scale_fill_uchicago()
    
    
}

single_plot <- function(data, x_col = NULL){
  
  if(is.null(x_col)){
    x_col =    names(data)[str_detect(names(data), "oy")] %>% rlang::sym()
  
  }else{
    x_col = rlang::sym(x_col)
  }
  
  data %>% 
    ggplot(aes(x = !!x_col, y = percent)) + 
    geom_col(color = 'black', 
             fill = color_contrast[2]) + 
    geom_errorbar(aes(ymax = percent_upp, ymin = !!error_bar_setting), 
                  width = .2) + 
    theme_classic() + 
    geom_text(aes(label = scales::percent(percent, digits = 3)), 
              position = position_stack(vjust = .5)) + 
    # labs( y = "Average Number of Children") + 
    erase_x_legend + 
    theme(axis.text.x = element_text(face = 'bold')) + 
    labs(
      caption = "Cells representing less than 5% suppressed for clarity"
    )
}

wrap_x_labels = 
  scale_x_discrete(labels = function(x) str_wrap(x,10))

basic_plot_dodge <- function(data, fill_label = NULL){
  
  fill_col = names(data)[2] %>% rlang::sym()
  
  x_col =    names(data)[str_detect(names(data), "oy")] %>% rlang::sym()
  
    data %>% 
    filter(!str_detect(!!x_col, '(Everyone)|(Eveyrone)')) %>% 
    ggplot(aes(x = !!x_col, y = percent, fill = !!fill_col)) + 
    geom_col(color = 'black', 
             position = 'dodge') + 
    # geom_text(aes(label = scales::percent(percent, accuracy = .1),
    #               group = !!fill_col), 
    #           position = position_dodge(width = .87), 
    #           vjust = 1.3) +
    # geom_errorbar(aes(ymin = percent, ymax = percent_upp, 
    #                   group = !!fill_col), 
    #               width = .5, 
    #               position = position_dodge(1))+
    theme_classic() + 
    scale_y_continuous(labels = scales::percent) + 
    
    erase_y_axis + 
    erase_x_legend + 
    theme(axis.text.x = element_text(face = 'bold')) + 
    labs(
      caption = "Cells representing less than 5% suppressed for clarity") 
    # scale_fill_manual(values = color_contrast_hh)
  
  
}


```

# Research Questions of Interest

* Are Opportunity Youth caring for children?
* What are the household income characteristics of Opportunity Youth?
* Mobility Status

# Heads of Household

```{r}
analysis_data$q2_household$head_of_household_alt %>%
  filter(!str_detect(oy_hh_flag, "Eve")) %>% 
  single_plot(x_col = 'oy_hh_flag') + 
  wrap_x_labels + 
  scale_y_continuous(labels = scales::percent) + 
  labs(caption = "", 
       y = "Percent") + 
  erase_y_axis
```


# Do they have children?

```{r}
# children are now individual level so I can say, does a given individual have at least one child?

ipums_data$at_least_one_child %>% 
  basic_plot_dodge() + 
  geom_errorbar(aes(ymin = percent, ymax = percent_upp,
                    group = at_least_one_child),
                width = .5,
                position = position_dodge(.9))+
  labs(fill = "Parental Status") + 
  wrap_x_labels + 
  scale_fill_manual(values = color_contrast_alt)
  



```

# Number of Children

```{r, eval = T}

# analysis_data$hh_num_children %>% 
#   filter(!str_detect(oy_hh_flag, 'Eve')) %>% 
#   
#   ggplot(aes(x = oy_hh_flag, y = percent)) + 
#   geom_col(color = 'black', 
#            fill = color_contrast[2]) + 
#   geom_errorbar(aes(ymax = percent_upp, ymin = !!error_bar_setting), 
#                 width = .2) + 
#   theme_classic() + 
#   geom_text(aes(label = round(percent, digits = 2)), 
#             position = position_stack(vjust = .5)) + 
#   # labs( y = "Average Number of Children") + 
#   erase_x_legend + 
#   theme(axis.text.x = element_text(face = 'bold')) + 
#   labs(caption = "Cells representing less than 5% suppressed for clarity", 
#        y = 'Average number of children') + 
#   wrap_x_labels 
  
ipums_data$percent_children %>% 
  filter(oy_flag != "everyone_else") %>% 
  basic_plot_dodge() + 
  geom_errorbar(aes(ymin = percent, ymax = percent_upp,
                    group = NCHILD),
                width = .5,
                position = position_dodge(.9))



```

# Income Characteristics: Household Income

```{r}

analysis_data$household_income_estimates %>% 
  ggplot(aes(x = oy_household, y = percent)) + 
  geom_col(color = 'black', 
           fill = color_contrast[2]) + 
  geom_errorbar(aes(ymax = percent_upp, ymin = !!error_bar_setting), 
                width = .2) + 
  theme_classic() + 
  geom_text(aes(label = scales::dollar(percent)), 
            position = position_stack(vjust = .5)) + 
  # labs( y = "Average Number of Children") + 
  erase_x_legend + 
  theme(axis.text.x = element_text(face = 'bold')) + 
  labs(
    caption = "Cells representing less than 5% suppressed for clarity", 
    y = "Household Income") + 
  scale_y_continuous(labels = scales::dollar)


```




# Income Characteristics: Total Personal Income


```{r}

analysis_data$q2_household$average_income %>% 
  filter(!(str_detect(oy_flag, "Eve"))) %>% 
  ggplot(aes(x = oy_flag, y = percent)) + 
  geom_col(color = 'black', 
           fill = color_contrast[2]) + 
  geom_errorbar(aes(ymax = percent_upp, ymin = !!error_bar_setting), 
                width = .2) + 
  theme_classic() + 
  geom_text(aes(label = scales::dollar(percent)), 
            position = position_stack(vjust = .5), 
            size = 3.7) + 
  # labs( y = "Average Number of Children") + 
  erase_x_legend + 
  theme(axis.text.x = element_text(face = 'bold')) + 
  labs(
    y = "Total Personal Income",
    caption = "Cells representing less than 5% suppressed for clarity"
  ) + 
  wrap_x_labels + 
  scale_y_continuous(labels = scales::dollar)


  


```




```{r, eval = F}

# Income Characteristics: Income Bracket

analysis_data$hh_income_bracket %>% 
  # filter(oy_flag != "Everyone Else") %>% 
  basic_plot() + 
  labs(fill = "Income Bracket") + 
  wrap_x_labels + 
  scale_fill_manual(values = c(color_contrast_alt[2],color_palette(9), color_palette_light(9)))


```

# Income Characteristics: Food Stamps (Pending)


```{r, eval = F}
# household level
analysis_data$food_stamps %>% 
  basic_plot_dodge() + 
  labs(fill = "Food Stamp Recipient") + 
  wrap_x_labels + 
  scale_fill_manual(values = color_contrast_alt)


```

# Household Type:(Pending)

```{r, eval = F}
# household level
analysis_data$hh_type %>% 
  basic_plot_dodge() + 
  labs(fill = "Type of Household") + 
  scale_fill_manual(values = c(color_contrast[2], color_palette_light(8)))
  



```


# Household Characteristics: Workers in Family (Pending)


```{r, eval = F}

# household level
analysis_data$workers_in_fam %>% 
  basic_plot_dodge() + 
  labs(fill = "Number of workers in Family") + 
  wrap_x_labels + 
  scale_fill_manual(values = c(color_contrast_alt[2], color_palette_light(4)))
  

```




# Marital Status / Partnered
```{r}

# person level
analysis_data$q2_household$married %>% 
  basic_plot_dodge() + 
  labs(fill = "Marital Status") + 
  wrap_x_labels  + 
  scale_fill_manual(values = c(color_contrast_alt[2], rev(color_palette(5)))) + 
  geom_errorbar(aes(ymin = percent, ymax = percent_upp,
                    group = MAR_label),
                width = .5,
                position = position_dodge(.9))
  



```

# Partnered

```{r}
# person level
analysis_data$q2_household$partnered %>% 
  basic_plot_dodge() + 
  geom_errorbar(aes(ymin = percent, ymax = percent_upp,
                    group = PARTNER_label),
                width = .5,
                position = position_dodge(.9)) + 
  labs(fill = "Partner Status") + 
  wrap_x_labels  
  
```



# Same-sex households (Pending)

```{r, eval = F}

# household level
analysis_data$same_sex_married %>% 
  basic_plot_dodge() + 
  labs(fill = "Same-Sex Married Household") + 
  wrap_x_labels

```

# Multi-generational Families (Pending)

```{r, eval = F}

# household level
analysis_data$multigen %>% 
  basic_plot_dodge() + 
  labs(fill = "Multigenerational Family") + 
  wrap_x_labels




```



# Mobility: Migration

```{r}

# person level
analysis_data$q2_household$migration %>% 
  basic_plot_dodge() + 
  labs(fill = "Migration Status") + 
  wrap_x_labels + 
  scale_fill_manual(values = c(color_palette(3), color_contrast_alt[2]))

```

# Mobility: Mode of Transportation
```{r}
# Person level
analysis_data$q2_household$transportation_mode %>% 
  mutate(JWTR_label = str_remove(JWTR_label, "\\(.*\\)")) %>% 
  basic_plot_dodge() + 
  labs(fill = "Mode of Transport") + 
  wrap_x_labels + 
  scale_fill_manual(values = c(color_palette(9), color_palette_light(9)))

```

# Migration: Average Commute Time

```{r}

# mode of transportation
# person level 
analysis_data$q2_household$commute_bracket %>% 
  basic_plot_dodge() + 
  labs(fill = "Commute Time (minutes)") + 
  wrap_x_labels + 
  scale_fill_manual(values = c(color_contrast_alt[2], color_palette(9), color_palette_light(1)))



```





